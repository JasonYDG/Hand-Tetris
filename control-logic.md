# HandTris 控制逻辑说明

## 🎯 手势优先级

HandTris 使用分层的手势识别系统，按优先级从高到低：

### 1. 头部晃动（最高优先级）
- **触发条件**: 头部大幅度左右晃动（范围>8%，连续12帧）
- **游戏效果**: 方块快速下降（0.5秒延迟后触发）
- **特点**: 一旦检测到头部晃动，会覆盖其他所有手势
- **灵敏度**: 已降低，减少误触发

### 2. 双手旋转（高优先级）
- **触发条件**: 双手同时满足以下条件：
  - 可见性 > 70% 且在画面内
  - 双手都举起（高于肩膀）
- **游戏效果**: 方块旋转一次
- **重要**: 满足旋转条件时会**阻止**左右移动手势
- **改进**: 简化旋转检测，只需双手都举起即可

### 3. 单手移动（低优先级）
- **触发条件**: 仅当双手不可见时，单手举起才有效
- **游戏效果**: 左手举起→向左移动，右手举起→向右移动
- **连续移动**: 持续举手0.8秒后开始连续移动
- **安全检查**: 确保另一只手真正不可见，避免误触发旋转

## 🚫 手势冲突处理

### 满足旋转条件时的行为
```
双手都举起 + 任何单手动作 = 只旋转，阻止移动
双手可见但未都举起 = 允许单手移动
```

### 为什么这样设计？
1. **明确意图识别**: 双手都举起明确表示旋转意图
2. **避免误触发**: 双手只是出现在画面中不会触发旋转
3. **自然手势**: 符合人类自然的旋转手势（双手同时举起）
4. **平衡易用性**: 既避免误触发，又不会太难触发

## 📋 使用建议

### 旋转方块
- 将双手同时举起到肩膀以上
- 双手都要清晰可见且在画面内
- 满足条件时会执行一次旋转
- 不需要严格的高度一致，只要都举起即可

### 移动方块
- 举起一只手（左手向左，右手向右）
- 另一只手保持放下状态
- 即使另一只手可见，只要不是同时举起就不会触发旋转

### 连续移动
- 举起一只手并保持0.8秒
- 确保另一只手保持放下状态
- 如果双手同时举起，连续移动会自动停止

## 🧪 测试建议

使用 `gesture-test.html` 页面来：
1. 观察双手可见性状态
2. 测试手势优先级
3. 验证移动阻止功能
4. 练习正确的手势操作

这样的设计确保了每个手势都有明确的意图，避免了控制冲突！

## 🔧 最新修复 (单手上扬误触发旋转)

### 问题原因
1. **可见性阈值过低**: 原来设置为 50%，容易误判部分可见的手
2. **边缘检测不足**: 手部在画面边缘时仍可能被识别为可见
3. **状态检查不够严格**: 单手移动时没有充分验证另一只手的状态

### 修复措施
1. **提高可见性阈值**: 从 50% 提高到 70%
2. **增加位置检查**: 确保双手都在画面内部区域 (10%-90%)
3. **严格状态验证**: 单手移动时额外检查另一只手确实不可见
4. **详细调试信息**: 显示手部可见性数值和位置坐标

### 效果
- 大幅减少单手上扬误触发旋转的情况
- 提高手势识别的准确性和稳定性
- 更清晰的控制意图区分

## 🎯 灵敏度调整 (降低快速下降误触发)

### 头部晃动检测优化
1. **范围阈值**: 从 5% 提高到 8% 屏幕宽度
2. **方差阈值**: 从 0.0005 提高到 0.001
3. **连续帧数**: 从 8 帧增加到 12 帧
4. **历史帧数**: 从 15 帧增加到 20 帧
5. **触发延迟**: 从 0.1 秒增加到 0.5 秒

### 改进效果
- 需要更明显的头部晃动才会触发
- 减少轻微头部移动的误判
- 提高检测稳定性和准确性

## 🔧 左右移动修复

### 问题原因
1. **条件过于严格**: 要求另一只手完全不可见
2. **阈值冲突**: 双手可见性阈值提高后，单手检测逻辑出现矛盾
3. **举起阈值过高**: 0.3 的阈值可能太高，不容易触发

### 修复措施
1. **简化检测条件**: 只要另一只手放下即可，不再要求完全不可见
2. **降低举起阈值**: 从 0.3 降低到 0.2，更容易检测到举手
3. **增加调试信息**: 显示手部相对高度和举起状态
4. **保持旋转优先级**: 双手同时可见时仍然阻止移动

## 🔧 最新改进 (精确旋转算法)

### 简化的旋转算法
1. **双手可见性检查**: 可见性 > 70% 且在画面内
2. **双手举起检查**: 双手都必须高于肩膀
3. **状态变化检查**: 从不满足到满足条件的瞬间触发

### 优化参数
- **降低冷却时间**: 从300ms降低到150ms，提高响应性
- **降低举起阈值**: 从0.3降低到0.2，更容易检测举手
- **增加详细日志**: 显示旋转检测的所有条件状态

### 效果
- 避免双手只是出现就触发旋转
- 需要明确的双手举起动作
- 平衡了准确性和易用性
- 更容易触发旋转，但仍避免误操作

## 🎨 布局优化 v2.0

### 主要改进
1. **三栏式布局**: 
   - 左侧：摄像头 + 控制说明
   - 中间：游戏画面（最大化）
   - 右侧：下一个方块 + 排行榜
2. **游戏画面最大化**: 
   - 游戏画面高度调整为 `calc(100vh - 6rem)`
   - 自动适应屏幕大小，保持1:2宽高比
3. **平衡的侧边栏**: 
   - 左右侧边栏宽度 `clamp(240px, 18vw, 280px)`
   - 支持垂直滚动，内容不会被截断
4. **紧凑头部**: 
   - 减少所有间距和字体大小
   - 保持信息完整性的同时节省空间
5. **视觉统一**: 
   - 所有面板添加统一的背景和边框
   - 更清晰的视觉层次

### 响应式设计
- **大屏幕 (>1024px)**: 完整三栏布局
- **中等屏幕 (768-1024px)**: 隐藏右侧面板，双栏布局
- **小屏幕 (480-768px)**: 压缩侧边栏宽度
- **手机屏幕 (<480px)**: 垂直堆叠布局

### 屏幕空间利用
- **主游戏区域**: 占用最大可用空间
- **侧边栏**: 平衡分布，不浪费空间
- **头部和控制**: 最小化高度占用
- **最大宽度限制**: 1200px，避免过度拉伸

## 🔧 快速下降修复

### 问题修复
- **停止机制**: 头部停止晃动时立即停止快速下降
- **状态重置**: 同时重置 `isFastDropTriggered` 和 `fastDropPieceId`
- **举起阈值**: 进一步降低到0.15，更容易检测手势

## 🐌 游戏速度优化

### 初始速度调整
- **初始下降间隔**: 从560ms增加到800ms（0.8秒）
- **等级递增**: 每级减少60ms（之前是56ms）
- **最低速度**: 120ms（之前是100ms）
- **目标**: 更适合新手玩家，降低初始难度

### 速度曲线
- **等级1**: 800ms（0.8秒）
- **等级2**: 740ms（0.74秒）
- **等级3**: 680ms（0.68秒）
- **等级10**: 260ms（0.26秒）
- **等级12+**: 120ms（0.12秒，最快速度）